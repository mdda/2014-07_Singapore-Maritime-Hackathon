<html>
<head>
  <xscript type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></xscript>
  <xscript type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/2.10.0/d3.v2.min.js"></xscript>
  <script type="text/javascript" src="/static/js/jquery-1.11.1.min.js"></script>
  <script type="text/javascript" src="/static/js/d3.v3.min.js"></script>
  
  <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
  
  <script type="text/javascript" src="/static/js/jquery.tipsy.js"></script>
  <link href="/static/css/tipsy.css" rel="stylesheet" type="text/css" />
  <style>
    
    #map {
        width: 500px;
        height: 500px;
    }
    
    .SvgOverlay {
        position: relative;
        width: 500px;
        height: 500px;           
    }
    
    .SvgOverlay svg {
        position: absolute;
        top: -4000px;
        left: -4000px;
        width: 8000px;
        height: 8000px;        
    }
    
    /*
    .SvgOverlay path {
        stroke: Orange;
        stroke-width: 2px;
        fill: Orange;
        fill-opacity: .8;
    }
    */
  </style>
</head>
<body>
  <div id="map-wrap">
    <div id="map">
    </div>
  </div>

  <script>
var places = [
  {
    name: "Wollongong, Australia",
    location: {
      latitude: 1.258, 
      longitude: 103.694
    }
  },
  {
    name: "Newcastle, Australia",
    location: {
      latitude: 1.248, 
      longitude: 103.644
    }
  }
];

//var trails_old = 
var trails = 
// { vid : [ [ts, lat_, lon_, course, speed], ... ], ... }
// AWJ
{"51200": [[1400133463, 1.223218918, 103.6422882, 279.8482666, 6.677908421], [1400133763, 1.2235615739498316, 103.64031434884573, 279.8482666, 6.677908421], [1400134063, 1.2239042298996634, 103.63834049769147, 279.8482666, 6.677908421], [1400134363, 1.224246885849495, 103.63636664653721, 279.8482666, 6.677908421], [1400134663, 1.2245895417993269, 103.63439279538295, 279.8482666, 6.677908421], [1400134963, 1.2249321977491585, 103.63241894422869, 279.8482666, 6.677908421], [1400135263, 1.2252748536989901, 103.63044509307443, 279.8482666, 6.677908421], [1400135563, 1.225617509648822, 103.62847124192017, 279.8482666, 6.677908421], [1400135863, 1.2259601655986536, 103.6264973907659, 279.8482666, 6.677908421], [1400136163, 1.2263028215484855, 103.62452353961164, 279.8482666, 6.677908421]], "39681": [[1400133554, 1.217716694, 103.6179581, 0.0, 0.0]], "6532": [[1400133484, 1.226896286, 103.6449127, 167.6999969, 0.100000001]], "17670": [[1400133548, 1.251086116, 103.644577, 316.8999939, 0.099999994]], "26759": [[1400133516, 1.254663825, 103.6251068, 0.0, 0.0]], "41867": [[1400133474, 1.216469288, 103.6322098, 94.59999847, 0.900000036]], "69775": [[1400133533, 1.246816754, 103.6420212, 237.3089142, 3.017813921], [1400133833, 1.2463277691092969, 103.64125926702773, 237.3089142, 3.017813921], [1400134133, 1.2458387842185938, 103.64049733405547, 237.3089142, 3.017813921], [1400134433, 1.2453497993278908, 103.6397354010832, 237.3089142, 3.017813921], [1400134733, 1.244860814437188, 103.63897346811095, 237.3089142, 3.017813921], [1400135033, 1.244371829546485, 103.63821153513868, 237.3089142, 3.017813921], [1400135333, 1.243882844655782, 103.63744960216641, 237.3089142, 3.017813921], [1400135633, 1.2433938597650789, 103.63668766919415, 237.3089142, 3.017813921], [1400135933, 1.2429048748743758, 103.63592573622188, 237.3089142, 3.017813921], [1400136233, 1.2424158899836728, 103.63516380324961, 237.3089142, 3.017813921]], "94552": [[1400133563, 1.233896732, 103.6358795, 0.0, 0.0]], "92306": [[1400133532, 1.254893899, 103.6198502, 0.0, 0.0]], "84291": [[1400133554, 1.247601509, 103.6570969, 333.0011292, 8.299900055], [1400133854, 1.249820110807967, 103.65596652099242, 333.0011292, 8.299900055], [1400134154, 1.2520387126159338, 103.65483614198486, 333.0011292, 8.299900055], [1400134454, 1.2542573144239004, 103.65370576297728, 333.0011292, 8.299900055], [1400134754, 1.2564759162318673, 103.65257538396972, 333.0011292, 8.299900055], [1400135054, 1.2586945180398341, 103.65144500496214, 333.0011292, 8.299900055], [1400135354, 1.260913119847801, 103.65031462595458, 333.0011292, 8.299900055], [1400135654, 1.2631317216557678, 103.649184246947, 333.0011292, 8.299900055], [1400135954, 1.2653503234637347, 103.64805386793944, 333.0011292, 8.299900055], [1400136254, 1.2675689252717013, 103.64692348893186, 333.0011292, 8.299900055]], "51289": [[1400133481, 1.239254951, 103.6596375, 157.6999969, 18.20000076], [1400133781, 1.2342033058387627, 103.66170933099087, 157.6999969, 18.20000076], [1400134081, 1.2291516606775252, 103.66378116198173, 157.6999969, 18.20000076], [1400134381, 1.224100015516288, 103.6658529929726, 157.6999969, 18.20000076], [1400134681, 1.2190483703550505, 103.66792482396346, 157.6999969, 18.20000076], [1400134981, 1.2139967251938133, 103.66999665495433, 157.6999969, 18.20000076], [1400135281, 1.2089450800325758, 103.67206848594519, 157.6999969, 18.20000076], [1400135581, 1.2038934348713386, 103.67414031693606, 157.6999969, 18.20000076], [1400135881, 1.1988417897101011, 103.67621214792692, 157.6999969, 18.20000076], [1400136181, 1.193790144548864, 103.67828397891779, 157.6999969, 18.20000076]], "86043": [[1400133477, 1.252434015, 103.6079483, 0.0, 0.0]], "37788": [[1400133507, 1.233639121, 103.6415176, 129.0, 0.100000001]], "92417": [[1400133533, 1.24250555, 103.6444702, 91.8999939, 0.100000001]], "51419": [[1400133556, 1.261556387, 103.6397171, 72.0, 0.099999994]], "51748": [[1400133568, 1.223450065, 103.6354446, 0.0, 0.0]], "43303": [[1400133579, 1.225516677, 103.6268997, 0.0, 0.0]], "39208": [[1400133580, 1.239575028, 103.6420746, 0.0, 0.0]], "60807": [[1400133556, 1.223198056, 103.639534, 146.5999908, 0.100000001]], "95150": [[1400133563, 1.233720064, 103.6268997, 200.2136993, 4.606584072], [1400133863, 1.2324232040299454, 103.62642219635478, 200.2136993, 4.606584072], [1400134163, 1.231126344059891, 103.62594469270958, 200.2136993, 4.606584072], [1400134463, 1.2298294840898365, 103.62546718906437, 200.2136993, 4.606584072], [1400134763, 1.228532624119782, 103.62498968541917, 200.2136993, 4.606584072], [1400135063, 1.2272357641497276, 103.62451218177395, 200.2136993, 4.606584072], [1400135363, 1.225938904179673, 103.62403467812875, 200.2136993, 4.606584072], [1400135663, 1.2246420442096186, 103.62355717448354, 200.2136993, 4.606584072], [1400135963, 1.2233451842395642, 103.62307967083834, 200.2136993, 4.606584072], [1400136263, 1.2220483242695097, 103.62260216719312, 200.2136993, 4.606584072]], "37423": [[1400133532, 1.244897842, 103.6492767, 234.5133209, 0.087694541]], "51634": [[1400133483, 1.250822425, 103.644043, 32.70000076, 1.600000024], [1400133783, 1.2512263501779528, 103.64430231536308, 32.70000076, 1.600000024], [1400134083, 1.2516302753559059, 103.64456163072614, 32.70000076, 1.600000024], [1400134383, 1.2520342005338587, 103.64482094608923, 32.70000076, 1.600000024], [1400134683, 1.2524381257118118, 103.6450802614523, 32.70000076, 1.600000024], [1400134983, 1.2528420508897646, 103.64533957681537, 32.70000076, 1.600000024], [1400135283, 1.2532459760677175, 103.64559889217846, 32.70000076, 1.600000024], [1400135583, 1.2536499012456706, 103.64585820754154, 32.70000076, 1.600000024], [1400135883, 1.2540538264236234, 103.64611752290462, 32.70000076, 1.600000024], [1400136183, 1.2544577516015765, 103.64637683826768, 32.70000076, 1.600000024]], "87477": [[1400133460, 1.217317939, 103.6520844, 180.6999969, 0.400000006]], "57015": [[1400133521, 1.243739963, 103.6399155, 131.3999939, 0.100000001]], "54652": [[1400133534, 1.265703917, 103.651001, 330.5, 0.100000001]], "56553": [[1400133538, 1.243939996, 103.6112976, 0.0, 0.0]], "9279": [[1400133499, 1.253167272, 103.6090012, 0.0, 0.0]], "48195": [[1400133516, 1.244184971, 103.6071396, 0.0, 0.0]], "40135": [[1400133467, 1.212300777, 103.6496353, 101.6999969, 0.900000036]], "57804": [[1400133498, 1.216145992, 103.6436768, 166.9000092, 0.100000001]], "35148": [[1400133519, 1.25463891, 103.6389923, 0.0, 0.0]], "58190": [[1400133519, 1.233358383, 103.6512451, 0.0, 0.0]], "53583": [[1400133552, 1.239250064, 103.6342621, 0.0, 0.0]], "3921": [[1400133488, 1.239798784, 103.6278534, 123.9999924, 0.100000001]], "39250": [[1400133465, 1.225838304, 103.6269989, 0.0, 0.0]], "6099": [[1400133484, 1.224686623, 103.6480484, 0.0, 0.0]], "90838": [[1400133485, 1.215658307, 103.6432114, 0.0, 0.0]], "39127": [[1400133490, 1.216212034, 103.6430359, 0.0, 0.0]], "58712": [[1400133558, 1.217992783, 103.6485596, 216.9706879, 0.032073211]], "36569": [[1400133456, 1.254270554, 103.643486, 0.0, 0.0]], "34395": [[1400133572, 1.213630199, 103.6114502, 112.6040802, 7.607581615], [1400133872, 1.212752981545812, 103.61355715665846, 112.6040802, 7.607581615], [1400134172, 1.211875764091624, 103.61566411331692, 112.6040802, 7.607581615], [1400134472, 1.210998546637436, 103.6177710699754, 112.6040802, 7.607581615], [1400134772, 1.210121329183248, 103.61987802663387, 112.6040802, 7.607581615], [1400135072, 1.2092441117290598, 103.62198498329234, 112.6040802, 7.607581615], [1400135372, 1.2083668942748718, 103.6240919399508, 112.6040802, 7.607581615], [1400135672, 1.2074896768206838, 103.62619889660928, 112.6040802, 7.607581615], [1400135972, 1.2066124593664957, 103.62830585326775, 112.6040802, 7.607581615], [1400136272, 1.2057352419123077, 103.63041280992621, 112.6040802, 7.607581615]], "38750": [[1400133506, 1.229550004, 103.6427841, 0.0, 0.0]], "87903": [[1400133561, 1.267009974, 103.652092, 0.0, 0.0]], "23009": [[1400133514, 1.2468009, 103.606636, 0.0, 0.0]], "89575": [[1400133577, 1.244038582, 103.649971, 274.1572266, 6.306981087], [1400133877, 1.2441757468143209, 103.64808388401188, 274.1572266, 6.306981087], [1400134177, 1.2443129116286418, 103.64619676802378, 274.1572266, 6.306981087], [1400134477, 1.2444500764429627, 103.64430965203567, 274.1572266, 6.306981087], [1400134777, 1.2445872412572836, 103.64242253604756, 274.1572266, 6.306981087], [1400135077, 1.2447244060716045, 103.64053542005945, 274.1572266, 6.306981087], [1400135377, 1.2448615708859254, 103.63864830407135, 274.1572266, 6.306981087], [1400135677, 1.2449987357002463, 103.63676118808324, 274.1572266, 6.306981087], [1400135977, 1.2451359005145672, 103.63487407209513, 274.1572266, 6.306981087], [1400136277, 1.245273065328888, 103.63298695610702, 274.1572266, 6.306981087]], "8937": [[1400133566, 1.26678133, 103.656723, 117.5000076, 0.200000003]], "54252": [[1400133494, 1.218501687, 103.614624, 0.0, 0.0]], "19565": [[1400133551, 1.24383986, 103.6419983, 119.4000015, 0.100000001]], "55662": [[1400133515, 1.238609791, 103.6521988, 64.40000153, 0.300000012]], "7037": [[1400133482, 1.223250031, 103.6392593, 0.0, 0.0]], "30322": [[1400133538, 1.227916718, 103.6392365, 0.0, 0.0]], "42867": [[1400133547, 1.235980034, 103.64431, 0.0, 0.0]], "58229": [[1400133513, 1.236874461, 103.631073, 64.79999542, 0.100000001]], "52201": [[1400133487, 1.218928337, 103.614418, 48.09999847, 0.100000001]], "83320": [[1400133552, 1.230763316, 103.6563263, 202.1957855, 0.052502107]], "31228": [[1400133535, 1.223065019, 103.6394043, 0.0, 0.0]], "35325": [[1400133562, 1.253131866, 103.6096802, 34.0, 0.100000001]]}
// T6
;

/*
// Embarrassing fix-up of the 'old' format - because need to retain compatibility just-in-case
var trails={};
for(var k in trails_old) {
  var arr=[];
  for(i=0; i<trails_old[k].length; i++) {
    arr.push(trails_old[k][i][0]);
  }
  trails[k]=arr;
}
*/

$(function () {
  var $map = $("#map");
  var map = new google.maps.Map($map[0], {
    zoom: 12,
    //mapTypeId: google.maps.MapTypeId.ROADMAP,
    //mapTypeId: google.maps.MapTypeId.SATELLITE,
    mapTypeId: google.maps.MapTypeId.TERRAIN,
    //center: new google.maps.LatLng(-18.2, 35.1), // Mozambique
    center: new google.maps.LatLng(1.258, 103.694), // Singapore
    //center: new google.maps.LatLng(1.269997, 103.795875), // Singapore Pasir Panjang           
    styles:[
      //{"stylers": [{"saturation": -75},{"lightness": 75}]}
      {"stylers": [{"saturation": -25},{"lightness": 25}]}
    ]           
  });
  
  var overlay = new google.maps.OverlayView();
  overlay.onAdd = function () {
    //var layer = d3.select(this.getPanes().overlayLayer).append("div").attr("class", "SvgOverlay");
    var layer = d3.select(this.getPanes().overlayMouseTarget).append("div").attr("class", "SvgOverlay");
    var svg = layer.append("svg");
    
    var adminDivisions = svg.append("g").attr("class", "AdminDivisions");

    overlay.draw = function () {
      var markerOverlay = this;
      var overlayProjection = markerOverlay.getProjection();

      // Turn the overlay projection into a d3 projection
      var googleMapProjection = function (coordinates) {
          var googleCoordinates = new google.maps.LatLng(coordinates[1], coordinates[0]);
          var pixelCoordinates = overlayProjection.fromLatLngToDivPixel(googleCoordinates);
          return [pixelCoordinates.x + 4000, pixelCoordinates.y + 4000];
      }

      // http://stackoverflow.com/questions/11909099/overlay-d3-paths-onto-google-maps
      // http://stackoverflow.com/questions/20987535/plotting-points-on-a-map-with-d3
  
      // Wish I had seen earlier : http://blog.safaribooksonline.com/2014/02/11/d3-js-maps/
      
      function proj_places(d) {
        return "translate(" + googleMapProjection([
          d.location.longitude,
          d.location.latitude
        ]) + ")"
      }
      function proj(d) {
        console.log(d);
        return "translate(" + googleMapProjection([
          d[2],d[1]
        ]) + ")"
      }
      
      // http://jaketrent.com/post/rotate-gauge-needle-in-d3/
      function triangle_ship(speed, gt, course) {
        return triangle_rotated(speed*2, 5, course+90);
      }
      
      function triangle_rotated(l,b, angle) {
        var theta = angle * Math.PI / 180;  // 0=pointing west, clockwise is positive

        var centerX = 0;
        var centerY = 0;

        var topX = centerX - l * Math.cos(theta);
        var topY = centerY - l * Math.sin(theta);

        var leftX = centerX - b * Math.cos(theta - Math.PI / 2)
        var leftY = centerY - b * Math.sin(theta - Math.PI / 2)

        var rightX = centerX - b * Math.cos(theta + Math.PI / 2)
        var rightY = centerY - b * Math.sin(theta + Math.PI / 2)

        //return "M #{leftX} #{leftY} L #{topX} #{topY} L #{rightX} #{rightY}"
        return ["M", leftX, leftY, "L", topX, topY, "L", rightX, rightY].join(' ');
      }
      
      function vessel_tooltip(d) {
        return "ID : "+d[0]+"<br/><ul><li>dfsdf</li><li>sdfsdsdf</li></ul>";
      }
      
      // for(var a in { r:23, t:566}) { console.log(a); }
      // { vid : [ [ts, lat_, lon_, course, speed], ... ], ... }

      for(var k in trails) {
        if(trails[k].length == 1) {
          adminDivisions.selectAll(".stopped"+k)
              .data(trails[k])
              .attr("transform", proj)
            .enter().append("circle")
              .attr("class", "stopped"+k)
              .attr("r", 3)
              .attr("fill", "red")
              .attr("transform", proj)
          ;
          $('.stopped'+k).tipsy({ 
            gravity: 'n', html: true, 
            title: function() { return vessel_tooltip(this.__data__);  }
          });
        }
        else {
          adminDivisions.selectAll(".moving"+k)
              .data(trails[k])
              .attr("transform", proj)
            .enter().append("svg:path")
              //.attr("d", "m0,-5L20,0L0,5z")
              .attr("d", function(d) { 
                //return triangle_ship(10,5,25);
                return triangle_ship(d[4],5,d[3]);
              })
              .attr("class", "moving"+k)
              .attr("fill", "green")
              .attr("fill-opacity", function(d,i) {
                console.log(k+":["+i+"]");
                return (100 - i/5 * 100)/100;
              })
              .attr("transform", proj)
          ;
          
          // Also : http://rideme.info/blog/Adding-a-Tooltip-in-D3-to-a-Google-Maps-Overlay-36388.html
          $('.moving'+k).tipsy({ 
            gravity: 'n', html: true, 
            title: function() { return vessel_tooltip(this.__data__);  }
          });
        }
      }
        
      console.log("ASDSADA");
      
    };

  };

  overlay.setMap(map);
  
});
    </script>

</body>
</html>
